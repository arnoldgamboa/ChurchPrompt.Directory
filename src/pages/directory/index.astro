---
import MainLayout from '@/layouts/MainLayout.astro';
import { DirectoryWithProvider } from '@/components/directory/DirectoryWithProvider';

export const prerender = false;

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

// SEO metadata
const title = "AI Prompts for Church Ministry - Browse ChatGPT & AI Prompts | Church Prompt Directory";
const description = "Discover 100+ AI prompts for churches. Get ChatGPT prompts for sermons, pastoral care, worship planning, and ministry. Free AI prompt library for pastors and church leaders. Copy and use proven AI prompts instantly.";
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Get query parameters for dynamic SEO
const categoryParam = Astro.url.searchParams.get('category');
const searchParam = Astro.url.searchParams.get('search');

// Fetch category data if category filter is present
let categoryName = '';
let categoryDescription = '';
if (categoryParam && convexUrl) {
  try {
    const response = await fetch(`${convexUrl}/api/query`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        path: 'categories:getCategories',
        args: {},
        format: 'json',
      }),
    });
    
    if (response.ok) {
      const result = await response.json();
      const categories = result.value || [];
      const category = categories.find((c: any) => c.categoryId === categoryParam);
      if (category) {
        categoryName = category.name;
        categoryDescription = category.description;
      }
    }
  } catch (error) {
    console.error('Failed to fetch categories:', error);
  }
}

// Dynamic title and description based on filters
const dynamicTitle = categoryName 
  ? `${categoryName} AI Prompts - ChatGPT Prompts for ${categoryName} | Church Prompt Directory`
  : searchParam
  ? `"${searchParam}" AI Prompts for Churches - Search Results | Church Prompt Directory`
  : title;

const dynamicDescription = categoryName
  ? `Explore ${categoryName.toLowerCase()} AI prompts for churches. Free ChatGPT and AI prompts for ${categoryName.toLowerCase()} ministry. ${categoryDescription} Copy and use instantly.`
  : searchParam
  ? `Find AI prompts for "${searchParam}" - Browse ChatGPT prompts and AI tools for church ministry, pastoral care, and faith-based content. Free prompt library.`
  : description;
---

<MainLayout title={dynamicTitle} description={dynamicDescription}>
  <!-- Enhanced SEO Meta Tags -->
  <Fragment slot="head">
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={dynamicTitle} />
    <meta property="og:description" content={dynamicDescription} />
    <meta property="og:site_name" content="Church Prompt Directory" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={dynamicTitle} />
    <meta name="twitter:description" content={dynamicDescription} />
    
    <!-- Additional SEO -->
    <meta name="keywords" content="AI prompts, church prompts, ChatGPT prompts for pastors, AI for churches, ministry AI prompts, sermon prompts, pastoral care AI, worship planning prompts, church AI tools, prompt library, prompt directory, AI prompt examples, free church prompts, ministry prompts, religious AI prompts, faith-based AI, church content AI, pastoral AI assistant, church communication prompts, church leadership AI" />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    <meta name="author" content="Church Prompt Directory" />
    <meta http-equiv="content-language" content="en-US" />
    <meta name="geo.region" content="US" />
    <meta name="target" content="all" />
    <meta name="audience" content="pastors, church leaders, ministry staff, worship leaders" />
    
    <!-- Additional Open Graph -->
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="Church Prompt Directory - AI Prompts for Ministry" />
    
    <!-- Additional Twitter -->
    <meta name="twitter:creator" content="@ChurchPrompts" />
    <meta name="twitter:site" content="@ChurchPrompts" />
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": dynamicTitle,
      "description": dynamicDescription,
      "url": canonicalURL,
      "isPartOf": {
        "@type": "WebSite",
        "name": "Church Prompt Directory",
        "url": Astro.site
      },
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": Astro.site
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Directory",
            "item": canonicalURL
          }
        ]
      }
    })} />
  </Fragment>

  <div class="container py-8">
    <DirectoryWithProvider 
      client:only="react"
      convexUrl={convexUrl}
    />
  </div>
</MainLayout>
