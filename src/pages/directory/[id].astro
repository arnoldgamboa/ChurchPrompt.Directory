---
import MainLayout from '@/layouts/MainLayout.astro';
import { ArrowLeft } from 'lucide-react';
import { PromptDetailWithProvider } from '@/components/prompts/PromptDetailWithProvider';

export const prerender = true;

export async function getStaticPaths() {
  const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;
  if (!convexUrl) return [];

  try {
    const idsResp = await fetch(`${convexUrl}/api/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        path: 'prompts:getAllPromptIds',
        args: {},
        format: 'json',
      }),
    });
    if (!idsResp.ok) {
      console.error('Failed to fetch prompt ids');
      return [];
    }
    const idsJson = await idsResp.json();
    const ids: { _id: string }[] = idsJson.value || [];
    // Parallel fetch each prompt
    const promptsData = await Promise.all(
      ids.map(async (p) => {
        try {
          const promptResp = await fetch(`${convexUrl}/api/query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              path: 'prompts:getPromptById',
              args: { id: p._id },
              format: 'json',
            }),
          });
          if (!promptResp.ok) return null;
          const promptJson = await promptResp.json();
          return { id: p._id, data: promptJson.value };
        } catch {
          return null;
        }
      })
    );
    return promptsData
      .filter((p) => p && p.data)
      .map((p: any) => ({ params: { id: p.id }, props: { promptData: p.data } }));
  } catch (error) {
    console.error('Error building static prompt paths', error);
    return [];
  }
}

const { id } = Astro.params;
// promptData supplied via getStaticPaths props
// @ts-ignore
const { promptData } = Astro.props as { promptData: any };
if (!id) return Astro.redirect('/404');

let title = "AI Prompt for Church Ministry | Church Prompt Directory";
let description = "Discover this AI prompt for church ministry. Free ChatGPT prompt designed for pastors and church leaders. Copy and use this proven AI prompt instantly.";
if (promptData) {
  title = `${promptData.title} - AI Prompt for ${promptData.category} | Church Prompt Directory`;
  const excerptText = promptData.excerpt || (promptData.content || '').substring(0, 120);
  description = `AI Prompt: ${excerptText}${excerptText.length >= 120 ? '...' : ''} Free ChatGPT prompt for church ${promptData.category?.toLowerCase()}.`;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<MainLayout title={title} description={description}>
  <!-- Enhanced SEO Meta Tags -->
  <Fragment slot="head">
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />
    
    {promptData && (
      <>
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="article" />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:site_name" content="Church Prompt Directory" />
        <meta property="article:published_time" content={new Date(promptData.createdAt).toISOString()} />
        <meta property="article:modified_time" content={new Date(promptData.updatedAt).toISOString()} />
        <meta property="article:author" content={promptData.authorName} />
        <meta property="article:section" content={promptData.category} />
        {promptData.tags.map((tag: string) => (
          <meta property="article:tag" content={tag} />
        ))}
        
        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={canonicalURL} />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        
        <!-- Additional SEO -->
        <meta name="keywords" content={`AI prompt, ${promptData.category} prompt, church AI, ChatGPT prompt, ministry AI, ${promptData.tags.join(', ')}, AI for churches, prompt example, free church prompt, ${promptData.category} AI tool`} />
        <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large" />
        <meta name="author" content={promptData.authorName} />
        <meta http-equiv="content-language" content="en-US" />
        
        <!-- Additional Open Graph -->
        <meta property="og:locale" content="en_US" />
        <meta property="article:publisher" content="Church Prompt Directory" />
        
        <!-- Additional Twitter -->
        <meta name="twitter:label1" content="Category" />
        <meta name="twitter:data1" content={promptData.category} />
        <meta name="twitter:label2" content="Reading time" />
        <meta name="twitter:data2" content="2 min read" />
        
        <!-- JSON-LD Structured Data -->
        <script type="application/ld+json" set:html={JSON.stringify({
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": promptData.title,
          "description": description,
          "author": {
            "@type": "Person",
            "name": promptData.authorName
          },
          "datePublished": new Date(promptData.createdAt).toISOString(),
          "dateModified": new Date(promptData.updatedAt).toISOString(),
          "publisher": {
            "@type": "Organization",
            "name": "Church Prompt Directory",
            "url": Astro.site
          },
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": canonicalURL
          },
          "keywords": promptData.tags.join(', '),
          "articleSection": promptData.category,
          "interactionStatistic": [
            {
              "@type": "InteractionCounter",
              "interactionType": "https://schema.org/UseAction",
              "userInteractionCount": promptData.usageCount
            },
            {
              "@type": "InteractionCounter",
              "interactionType": "https://schema.org/ActivateAction",
              "userInteractionCount": promptData.executionCount
            }
          ],
          "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
              {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": Astro.site
              },
              {
                "@type": "ListItem",
                "position": 2,
                "name": "Directory",
                "item": new URL('/directory', Astro.site)
              },
              {
                "@type": "ListItem",
                "position": 3,
                "name": promptData.title,
                "item": canonicalURL
              }
            ]
          }
        })} />
      </>
    )}
  </Fragment>

  <div class="container py-8">
    <div class="mb-6">
      <a href="/directory" class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors">
        <ArrowLeft className="h-4 w-4" />
        Back to Directory
      </a>
    </div>
    <PromptDetailWithProvider client:load convexUrl={import.meta.env.PUBLIC_CONVEX_URL} promptId={id} isSubscribed={true} isFavorite={false} initialPrompt={promptData} />
  </div>
</MainLayout>
