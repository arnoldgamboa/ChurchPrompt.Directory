---
import MainLayout from '@/layouts/MainLayout.astro';
import { marked } from 'marked';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

if (!convexUrl) {
  throw new Error('PUBLIC_CONVEX_URL is not set');
}

export const prerender = false;

const { slug } = Astro.params;

// Define blog type
interface Blog {
  _id: string;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  authorName: string;
  tags: string[];
  metaDescription: string;
  metaKeywords: string[];
  status: string;
  featured: boolean;
  publishedAt?: number;
  createdAt: number;
  updatedAt: number;
  featuredImage?: string;
}

// Server-side data fetching using Convex HTTP API
let blog: Blog | null = null;
let title = "Blog Post | Church Prompt Directory";
let description = "Read our latest insights and tips for church ministry.";
let keywords = "church, ministry, AI prompts, spiritual growth";
let ogImage = "";
let canonicalUrl = `${Astro.site?.toString() || 'https://churchprompt.directory'}/blogs/${slug}`;

try {
  // Use Convex HTTP API directly (works in any environment)
  const response = await fetch(`${convexUrl}/api/query`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      path: 'blogs:getBlogBySlug',
      args: { slug: slug || '' },
    }),
  });
  
  if (response.ok) {
    const result = await response.json();
    blog = result.value;
  }
  
  if (blog) {
    title = `${blog.title} | Church Prompt Directory`;
    description = blog.metaDescription || blog.excerpt;
    keywords = blog.metaKeywords.join(', ');
    ogImage = blog.featuredImage || `${Astro.site?.toString() || 'https://churchprompt.directory'}/og-image.png`;
  }
} catch (error) {
  console.error('Error fetching blog for SSR:', error);
}

// If blog not found, return 404
if (!blog) {
  return Astro.redirect('/404');
}

// Format date helper
function formatDate(timestamp: number | undefined): string {
  if (!timestamp) return '';
  return new Date(timestamp).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Configure marked for safe rendering
marked.setOptions({
  gfm: true,
  breaks: true,
});

// Render markdown to HTML on the server
const contentHtml = marked.parse(blog.content);
---

<MainLayout 
  title={title} 
  description={description}
  keywords={keywords}
  ogTitle={title}
  ogDescription={description}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={canonicalUrl}
>
  <div class="container py-12">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Back button -->
      <div class="mb-8">
        <a href="/blogs" class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-primary transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          Back to Blog
        </a>
      </div>

      <article itemscope itemtype="https://schema.org/BlogPosting" class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
          {blog.featured && (
            <span class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold bg-primary/10 text-primary mb-6">
              Featured Post
            </span>
          )}
          
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 tracking-tight text-foreground" itemprop="headline">{blog.title}</h1>
          
          <!-- Meta information -->
          <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-muted-foreground mb-8">
            <span class="flex items-center gap-2" itemprop="author" itemscope itemtype="https://schema.org/Person">
              <div class="w-8 h-8 rounded-full bg-muted flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <span itemprop="name" class="font-medium text-foreground">{blog.authorName}</span>
            </span>
            
            <time datetime={blog.publishedAt ? new Date(blog.publishedAt).toISOString() : ''} itemprop="datePublished" class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
              {formatDate(blog.publishedAt)}
            </time>
          </div>

          <!-- Featured Image -->
          {blog.featuredImage && (
             <div class="mb-10 rounded-xl overflow-hidden shadow-lg border bg-muted aspect-video relative">
                <img 
                  src={blog.featuredImage} 
                  alt={blog.title}
                  class="w-full h-full object-cover"
                  itemprop="image"
                />
             </div>
          )}

          <!-- Excerpt -->
          {blog.excerpt && (
            <p class="text-xl md:text-2xl text-muted-foreground leading-relaxed max-w-2xl mx-auto" itemprop="description">
              {blog.excerpt}
            </p>
          )}
        </header>

        <hr class="my-10 border-muted" />

        <!-- Content - Server-rendered HTML -->
        <div class="mb-16">
            <div 
              class="prose prose-lg prose-slate dark:prose-invert max-w-none
                prose-headings:font-bold prose-headings:tracking-tight
                prose-h1:text-3xl prose-h1:mt-12 prose-h1:mb-6
                prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4
                prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
                prose-p:leading-8 prose-p:mb-6
                prose-a:text-primary prose-a:no-underline prose-a:border-b prose-a:border-primary/30 prose-a:hover:border-primary prose-a:transition-colors
                prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:my-8 prose-blockquote:text-muted-foreground prose-blockquote:bg-muted/30 prose-blockquote:py-2 prose-blockquote:pr-4 prose-blockquote:rounded-r
                prose-code:bg-muted prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:text-foreground
                prose-pre:bg-muted prose-pre:p-6 prose-pre:rounded-xl prose-pre:shadow-sm prose-pre:overflow-x-auto prose-pre:my-8
                prose-img:rounded-xl prose-img:shadow-md prose-img:my-8"
              itemprop="articleBody"
              set:html={contentHtml}
            />
        </div>

        <!-- Tags -->
        {blog.tags.length > 0 && (
          <div class="mb-12 pt-8 border-t">
            <div class="flex items-center gap-3 flex-wrap">
              <span class="text-sm font-medium text-muted-foreground">
                Tags:
              </span>
              {blog.tags.map((tag) => (
                <a href={`/blogs?tag=${tag}`} class="inline-flex items-center rounded-full border px-3 py-1 text-sm font-medium hover:bg-muted transition-colors" itemprop="keywords">
                  {tag}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Footer navigation -->
        <div class="flex justify-between items-center pt-8 border-t">
          <a href="/blogs" class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            Back to All Posts
          </a>
        </div>
      </article>
    </div>
  </div>
</MainLayout>
