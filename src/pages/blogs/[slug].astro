---
import MainLayout from '@/layouts/MainLayout.astro';
import { BlogDetailWithProvider } from '@/components/blogs/BlogDetailWithProvider';
import { fetchQuery } from "convex/nextjs";
import { api } from "../../../convex/_generated/api";

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

if (!convexUrl) {
  throw new Error('PUBLIC_CONVEX_URL is not set');
}

export const prerender = false;

const { slug } = Astro.params;

// Server-side data fetching for SEO optimization
let blog = null;
let title = "Blog Post | Church Prompt Directory";
let description = "Read our latest insights and tips for church ministry.";
let keywords = "church, ministry, AI prompts, spiritual growth";
let ogImage = "";
let canonicalUrl = `${Astro.site?.toString() || 'https://churchprompt.directory'}/blogs/${slug}`;

try {
  // Fetch blog data on the server for SEO
  blog = await fetchQuery(api.blogs.getBlogBySlug, { slug: slug || '' }, { url: convexUrl });
  
  if (blog) {
    title = `${blog.title} | Church Prompt Directory`;
    description = blog.metaDescription || blog.excerpt;
    keywords = blog.metaKeywords.join(', ');
    // Use featured image if available (you can add this field to schema later)
    ogImage = blog.featuredImage || `${Astro.site?.toString() || 'https://churchprompt.directory'}/og-image.png`;
  }
} catch (error) {
  console.error('Error fetching blog for SSR:', error);
}

// If blog not found, return 404
if (!blog) {
  return Astro.redirect('/404');
}
---

<MainLayout 
  title={title} 
  description={description}
  keywords={keywords}
  ogTitle={title}
  ogDescription={description}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={canonicalUrl}
>
  <BlogDetailWithProvider client:only="react" convexUrl={convexUrl} slug={slug} />
</MainLayout>
